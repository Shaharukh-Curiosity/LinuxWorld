'use strict';
<<<<<<< HEAD
const url = require('url');
const punycode = require('punycode');
const queryString = require('query-string');
const prependHttp = require('prepend-http');
const sortKeys = require('sort-keys');

const DEFAULT_PORTS = {
=======
var url = require('url');
var punycode = require('punycode');
var queryString = require('query-string');
var prependHttp = require('prepend-http');
var sortKeys = require('sort-keys');
var objectAssign = require('object-assign');

var DEFAULT_PORTS = {
>>>>>>> dc7ca8caa9759d4a9def25682707f917f8e9a75e
	'http:': 80,
	'https:': 443,
	'ftp:': 21
};

<<<<<<< HEAD
// Protocols that always contain a `//`` bit
const slashedProtocol = {
	http: true,
	https: true,
	ftp: true,
	gopher: true,
	file: true,
=======
// protocols that always contain a `//`` bit
var slashedProtocol = {
	'http': true,
	'https': true,
	'ftp': true,
	'gopher': true,
	'file': true,
>>>>>>> dc7ca8caa9759d4a9def25682707f917f8e9a75e
	'http:': true,
	'https:': true,
	'ftp:': true,
	'gopher:': true,
	'file:': true
};

function testParameter(name, filters) {
<<<<<<< HEAD
	return filters.some(filter => filter instanceof RegExp ? filter.test(name) : filter === name);
}

module.exports = (str, opts) => {
	opts = Object.assign({
=======
	return filters.some(function (filter) {
		return filter instanceof RegExp ? filter.test(name) : filter === name;
	});
}

module.exports = function (str, opts) {
	opts = objectAssign({
>>>>>>> dc7ca8caa9759d4a9def25682707f917f8e9a75e
		normalizeProtocol: true,
		normalizeHttps: false,
		stripFragment: true,
		stripWWW: true,
		removeQueryParameters: [/^utm_\w+/i],
		removeTrailingSlash: true,
<<<<<<< HEAD
		removeDirectoryIndex: false,
		sortQueryParameters: true
=======
		removeDirectoryIndex: false
>>>>>>> dc7ca8caa9759d4a9def25682707f917f8e9a75e
	}, opts);

	if (typeof str !== 'string') {
		throw new TypeError('Expected a string');
	}

<<<<<<< HEAD
	const hasRelativeProtocol = str.startsWith('//');

	// Prepend protocol
	str = prependHttp(str.trim()).replace(/^\/\//, 'http://');

	const urlObj = url.parse(str);
=======
	var hasRelativeProtocol = str.indexOf('//') === 0;

	// prepend protocol
	str = prependHttp(str.trim()).replace(/^\/\//, 'http://');

	var urlObj = url.parse(str);
>>>>>>> dc7ca8caa9759d4a9def25682707f917f8e9a75e

	if (opts.normalizeHttps && urlObj.protocol === 'https:') {
		urlObj.protocol = 'http:';
	}

	if (!urlObj.hostname && !urlObj.pathname) {
		throw new Error('Invalid URL');
	}

<<<<<<< HEAD
	// Prevent these from being used by `url.format`
	delete urlObj.host;
	delete urlObj.query;

	// Remove fragment
=======
	// prevent these from being used by `url.format`
	delete urlObj.host;
	delete urlObj.query;

	// remove fragment
>>>>>>> dc7ca8caa9759d4a9def25682707f917f8e9a75e
	if (opts.stripFragment) {
		delete urlObj.hash;
	}

<<<<<<< HEAD
	// Remove default port
	const port = DEFAULT_PORTS[urlObj.protocol];
=======
	// remove default port
	var port = DEFAULT_PORTS[urlObj.protocol];
>>>>>>> dc7ca8caa9759d4a9def25682707f917f8e9a75e
	if (Number(urlObj.port) === port) {
		delete urlObj.port;
	}

<<<<<<< HEAD
	// Remove duplicate slashes
=======
	// remove duplicate slashes
>>>>>>> dc7ca8caa9759d4a9def25682707f917f8e9a75e
	if (urlObj.pathname) {
		urlObj.pathname = urlObj.pathname.replace(/\/{2,}/g, '/');
	}

<<<<<<< HEAD
	// Decode URI octets
=======
	// decode URI octets
>>>>>>> dc7ca8caa9759d4a9def25682707f917f8e9a75e
	if (urlObj.pathname) {
		urlObj.pathname = decodeURI(urlObj.pathname);
	}

<<<<<<< HEAD
	// Remove directory index
=======
	// remove directory index
>>>>>>> dc7ca8caa9759d4a9def25682707f917f8e9a75e
	if (opts.removeDirectoryIndex === true) {
		opts.removeDirectoryIndex = [/^index\.[a-z]+$/];
	}

<<<<<<< HEAD
	if (Array.isArray(opts.removeDirectoryIndex) && opts.removeDirectoryIndex.length > 0) {
		let pathComponents = urlObj.pathname.split('/');
		const lastComponent = pathComponents[pathComponents.length - 1];
=======
	if (Array.isArray(opts.removeDirectoryIndex) && opts.removeDirectoryIndex.length) {
		var pathComponents = urlObj.pathname.split('/');
		var lastComponent = pathComponents[pathComponents.length - 1];
>>>>>>> dc7ca8caa9759d4a9def25682707f917f8e9a75e

		if (testParameter(lastComponent, opts.removeDirectoryIndex)) {
			pathComponents = pathComponents.slice(0, pathComponents.length - 1);
			urlObj.pathname = pathComponents.slice(1).join('/') + '/';
		}
	}

<<<<<<< HEAD
	// Resolve relative paths, but only for slashed protocols
	if (slashedProtocol[urlObj.protocol]) {
		const domain = urlObj.protocol + '//' + urlObj.hostname;
		const relative = url.resolve(domain, urlObj.pathname);
=======
	// resolve relative paths, but only for slashed protocols
	if (slashedProtocol[urlObj.protocol]) {
		var domain = urlObj.protocol + '//' + urlObj.hostname;
		var relative = url.resolve(domain, urlObj.pathname);
>>>>>>> dc7ca8caa9759d4a9def25682707f917f8e9a75e
		urlObj.pathname = relative.replace(domain, '');
	}

	if (urlObj.hostname) {
		// IDN to Unicode
		urlObj.hostname = punycode.toUnicode(urlObj.hostname).toLowerCase();

<<<<<<< HEAD
		// Remove trailing dot
		urlObj.hostname = urlObj.hostname.replace(/\.$/, '');

		// Remove `www.`
=======
		// remove trailing dot
		urlObj.hostname = urlObj.hostname.replace(/\.$/, '');

		// remove `www.`
>>>>>>> dc7ca8caa9759d4a9def25682707f917f8e9a75e
		if (opts.stripWWW) {
			urlObj.hostname = urlObj.hostname.replace(/^www\./, '');
		}
	}

<<<<<<< HEAD
	// Remove URL with empty query string
=======
	// remove URL with empty query string
>>>>>>> dc7ca8caa9759d4a9def25682707f917f8e9a75e
	if (urlObj.search === '?') {
		delete urlObj.search;
	}

<<<<<<< HEAD
	const queryParameters = queryString.parse(urlObj.search);

	// Remove query unwanted parameters
	if (Array.isArray(opts.removeQueryParameters)) {
		for (const key in queryParameters) {
=======
	var queryParameters = queryString.parse(urlObj.search);

	// remove query unwanted parameters
	if (Array.isArray(opts.removeQueryParameters)) {
		for (var key in queryParameters) {
>>>>>>> dc7ca8caa9759d4a9def25682707f917f8e9a75e
			if (testParameter(key, opts.removeQueryParameters)) {
				delete queryParameters[key];
			}
		}
	}

<<<<<<< HEAD
	// Sort query parameters
	if (opts.sortQueryParameters) {
		urlObj.search = queryString.stringify(sortKeys(queryParameters));
	}

	// Decode query parameters
	if (urlObj.search !== null) {
		urlObj.search = decodeURIComponent(urlObj.search);
	}

	// Take advantage of many of the Node `url` normalizations
	str = url.format(urlObj);

	// Remove ending `/`
=======
	// sort query parameters
	urlObj.search = queryString.stringify(sortKeys(queryParameters));

	// decode query parameters
	urlObj.search = decodeURIComponent(urlObj.search);

	// take advantage of many of the Node `url` normalizations
	str = url.format(urlObj);

	// remove ending `/`
>>>>>>> dc7ca8caa9759d4a9def25682707f917f8e9a75e
	if (opts.removeTrailingSlash || urlObj.pathname === '/') {
		str = str.replace(/\/$/, '');
	}

<<<<<<< HEAD
	// Restore relative protocol, if applicable
=======
	// restore relative protocol, if applicable
>>>>>>> dc7ca8caa9759d4a9def25682707f917f8e9a75e
	if (hasRelativeProtocol && !opts.normalizeProtocol) {
		str = str.replace(/^http:\/\//, '//');
	}

	return str;
};
